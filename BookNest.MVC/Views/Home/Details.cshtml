@using BookNest.Core.Entities
@using Microsoft.AspNetCore.Identity
@inject SignInManager<AppUser> SignInManager
@model Book

@{
    ViewData["Title"] = Model.Title;
}

<div class="book-hero">
    <div class="hero-left">
        @if (!string.IsNullOrEmpty(Model.ImageUrl))
        {
            <img src="~/uploads/books/@Model.ImageUrl" alt="@Model.Title">
        }
        else
        {
            <div style="width: 100%; height: 350px; background: #eee; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">No Cover</div>
        }
        
        <h3>@Model.Title</h3>
        <div class="stars">★★★★★</div>
        
        <form asp-controller="Shelf" asp-action="UpdateShelf" method="post" style="display: inline;">
            <input type="hidden" name="bookId" value="@Model.Id" />
            <button type="submit" name="newStatusId" value="1" class="buy-btn outline">Add to List</button>
            <button type="submit" name="newStatusId" value="2" class="buy-btn">Start Reading</button>
        </form>
    </div>
    
    <div class="hero-right">
        <h1>@Model.Title</h1>
        <div class="author-name">
            @(string.Join(", ", Model.BookAuthors.Select(ba => ba.Author.FullName)))
        </div>
        <div class="publish-date">Published Date: @(Model.PublishedDate?.ToString("d MMMM yyyy") ?? "Unknown")</div>

        <div class="desc-body">
            <div class="desc-text" id="bookDescription">
                @Model.Description
            </div>
            <button class="show-more-btn" id="showMoreBtn" onclick="toggleDescription()">Show more ▾</button>
        </div>

        <div class="genre-tags">
            <strong>GENRES :</strong> 
            @string.Join(" | ", Model.BookGenres.Select(bg => bg.Genre.Name))
        </div>

        <div class="reading-stats">
            <div class="stat-item">
                <div class="avatars">
                    <img src="https://randomuser.me/api/portraits/women/1.jpg">
                    <img src="https://randomuser.me/api/portraits/men/2.jpg">
                    <img src="https://randomuser.me/api/portraits/women/3.jpg">
                </div>
                70.8k people are currently reading
            </div>
            <div class="stat-item">
                <div class="avatars">
                    <img src="https://randomuser.me/api/portraits/women/4.jpg">
                    <img src="https://randomuser.me/api/portraits/men/5.jpg">
                </div>
                72k people wanted to read
            </div>
        </div>
    </div>
</div>

</div> <div class="tab-bar-wrapper">
    <div class="container">
        <div class="tab-bar">
            <div class="tab-btn active" onclick="switchTab('details', this)">
                <div class="tab-icon">!</div>
                Book Details
            </div>
            <div class="tab-btn" onclick="switchTab('reviews', this)">
                <div class="tab-icon">💬</div>
                Reviews
            </div>
        </div>
    </div>
</div>

<div class="container"> <div id="tab-details" class="details-content">
    <div class="section-title"><h2>Kitab Haqqında Əlavə Məlumat</h2></div>

    <h3>Müəllif Haqqında</h3>
    <div class="author-section">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b4/Tolkien_1916.jpg/220px-Tolkien_1916.jpg" alt="Author">
        <div class="author-info">
            Bu kitabın müəllifləri haqqında detallı bioqrafiya yaxın zamanda bura əlavə ediləcək...
        </div>
    </div>

    <h3>Book Information</h3>
    <table class="book-data-table">
        <tr>
            <td>Page Count</td>
            <td>@Model.PageCount pages</td>
        </tr>
        <tr>
            <td>Published Date</td>
            <td>@(Model.PublishedDate?.ToString("d MMMM yyyy") ?? "-")</td>
        </tr>
        <tr>
            <td>Language</td>
            <td>@(Model.Language ?? "Eng")</td>
        </tr>
    </table>
</div>

<div id="tab-reviews" class="details-content hidden">
    <div class="reviews-section" style="margin-top: 50px; border-top: 1px solid #E0DCD0; padding-top: 30px;">
        <h3 style="font-family: var(--font-serif); color: var(--text-dark); margin-bottom: 20px;">User Reviews</h3>

        <div id="reviewsList" style="margin-bottom: 40px; display: flex; flex-direction: column; gap: 15px;">
            <p style="color: #A39683;">Loading reviews...</p>
        </div>

        <div class="add-review-box" style="background: var(--bg-color); padding: 25px; border-radius: 12px; border: 1px solid #E0DCD0;">
            <h4 style="margin-bottom: 15px; color: var(--text-dark);">Share Your Review</h4>
            
            <form id="reviewForm">
                <input type="hidden" id="bookId" value="@Model.Id" />

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Rating (1-5)</label>
                    <select id="rating" style="padding: 10px; border-radius: 8px; border: 1px solid #C5BCAD; width: 100%; max-width: 200px; outline: none;">
                        <option value="5">⭐⭐⭐⭐⭐ (5/5)</option>
                        <option value="4">⭐⭐⭐⭐ (4/5)</option>
                        <option value="3">⭐⭐⭐ (3/5)</option>
                        <option value="2">⭐⭐ (2/5)</option>
                        <option value="1">⭐ (1/5)</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Your Review</label>
                    <textarea id="comment" rows="4" required placeholder="Share your thoughts about this book..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #C5BCAD; resize: vertical; font-family: var(--font-sans); outline: none;"></textarea>
                </div>

                <button type="submit" id="submitReviewBtn" style="background: var(--text-dark); color: white; border: none; padding: 12px 25px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: 0.3s;">
                    Submit Review
                </button>
                
                <p id="reviewMessage" style="margin-top: 10px; font-size: 14px; font-weight: 500;"></p>
            </form>
        </div>
    </div>
</div>

</div> <div class="similar-books">
    <div class="container">
        <h2>Similar Books</h2>
        @await Component.InvokeAsync("FeaturedBooks")
    </div>
</div>

@section Scripts {
    <script>
        function switchTab(tabId, element) {
            // Hide tab contents
            document.getElementById('tab-details').classList.add('hidden');
            document.getElementById('tab-reviews').classList.add('hidden');

            // Delete active class at all buttons
            let buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Show selected tabs
            document.getElementById('tab-' + tabId).classList.remove('hidden');

            // Give active class to button
            element.classList.add('active');
        }

                function toggleDescription() {
            var desc = document.getElementById("bookDescription");
            var btn = document.getElementById("showMoreBtn");

            desc.classList.toggle("expanded");

            if (desc.classList.contains("expanded")) {
                btn.innerHTML = "Show less ▴";
            } else {
                btn.innerHTML = "Show more ▾";
            }
        }

        //JavaScript code for handling reviews (fetching and submitting)
            document.addEventListener("DOMContentLoaded", function () {
            const bookId = document.getElementById("bookId").value;
            const reviewsList = document.getElementById("reviewsList");
            const reviewForm = document.getElementById("reviewForm");
            const reviewMessage = document.getElementById("reviewMessage");
            const submitBtn = document.getElementById("submitReviewBtn");

            // 1. Səhifə açılanda rəyləri API-dən gətirən funksiya
            function loadReviews() {
                fetch(`/api/Reviews/${bookId}`)
                    .then(response => response.json())
                    .then(data => {
                        reviewsList.innerHTML = ""; // Yüklənir yazısını silirik

                        if (data.length === 0) {
                            reviewsList.innerHTML = "<p style='color: #A39683;'>Bu kitaba hələ rəy yazılmayıb. İlk yazan siz olun!</p>";
                            return;
                        }

                        // Hər bir rəy üçün HTML yaradırıq
                        data.forEach(review => {
                            // Tarixi səliqəli formata salırıq (Məsələn: 26 Fev 2026)
                            const dateObj = new Date(review.date);
                            const formattedDate = dateObj.toLocaleDateString('az-AZ', { day: 'numeric', month: 'short', year: 'numeric' });

                            // Ulduzları çəkmək üçün (Məsələn 4 ulduz = ⭐⭐⭐⭐)
                            const stars = "⭐".repeat(review.rating);

                            // Profil şəkli yoxdursa standart şəkil qoyuruq
                            const userImg = review.userImage ? `/uploads/profiles/${review.userImage}` : "https://randomuser.me/api/portraits/lego/1.jpg";

                            const reviewHtml = `
                                <div style="background: white; padding: 15px; border-radius: 10px; border: 1px solid #F0EBE1; display: flex; gap: 15px;">
                                    <img src="${userImg}" style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;" alt="User">
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <strong style="color: var(--text-dark);">${review.userName}</strong>
                                            <span style="color: #A39683; font-size: 12px;">${formattedDate}</span>
                                        </div>
                                        <div style="margin-bottom: 8px; font-size: 14px;">${stars}</div>
                                        <p style="margin: 0; font-size: 14px; color: #555; line-height: 1.5;">${review.comment}</p>
                                    </div>
                                </div>
                            `;
                            reviewsList.innerHTML += reviewHtml;
                        });
                    })
                    .catch(err => console.error("Rəylər yüklənərkən xəta baş verdi:", err));
            }

            // 2. Form göndəriləndə API-yə (POST) sorğu atan funksiya
            reviewForm.addEventListener("submit", function (e) {
                e.preventDefault(); // Səhifənin yenilənməsinin qarşısını alırıq!

                // Düyməni deaktiv edirik ki, istifadəçi 2 dəfə basa bilməsin
                submitBtn.disabled = true;
                submitBtn.innerText = "Göndərilir...";
                reviewMessage.innerText = "";

                const payload = {
                    bookId: parseInt(bookId),
                    rating: parseInt(document.getElementById("rating").value),
                    comment: document.getElementById("comment").value
                };

                fetch("/api/Reviews", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json" // Backend-ə JSON göndərdiyimizi deyirik
                    },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                // 1. Əgər 401 (Giriş edilməyib) xətasıdırsa, JSON oxumağa çalışma!
                if (response.status === 401) {
                    reviewMessage.style.color = "red";
                    reviewMessage.innerText = "Rəy yazmaq üçün sistemə daxil olmalısınız!";
                    return; // Buradan çıxırıq
                }

                // Digər hallarda (Məsələn 200 OK və ya 400 Bad Request) JSON-u oxu
                const data = await response.json();

                if (response.ok) {
                    reviewMessage.style.color = "green";
                    reviewMessage.innerText = data.message;
                    reviewForm.reset(); // Formu təmizlə
                    loadReviews(); // Siyahını yenilə!
                } else {
                    reviewMessage.style.color = "red";
                    reviewMessage.innerText = data.message || "Xəta baş verdi. Zəhmət olmasa məlumatları düzgün daxil edin.";
                }
            })
                .catch(err => {
                    reviewMessage.style.color = "red";
                    reviewMessage.innerText = "Serverlə əlaqə qurularkən xəta baş verdi.";
                    console.error(err);
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerText = "Rəy Göndər";
                });
            });

            // 3. Səhifə açılanda rəyləri ilk dəfə yükləyirik
            loadReviews();
        });







    </script>
}